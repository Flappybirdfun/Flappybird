<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="x-ogp-key" content="your-api-key" />
    <title>Retro Flappy Bird - Responsive Edition</title>
    <script src="https://sdk.play.fun"></script>
    <style>
        :root {
            --game-width: 800px;
            --game-height: 600px;
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #1a1a1a;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            touch-action: none; 
        }
        #game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: var(--game-width);
            max-height: var(--game-height);
            aspect-ratio: 4 / 3;
            box-shadow: 0 0 40px rgba(0,0,0,0.7);
            background-color: #70c5ce;
            overflow: hidden;
        }
        canvas {
            width: 100% !important;
            height: 100% !important;
            display: block;
            image-rendering: pixelated;
        }
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            color: white;
            text-shadow: 2px 2px #000;
            pointer-events: none;
            text-align: center;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 5%;
            box-sizing: border-box;
            z-index: 10;
        }
        .score-container {
            margin-top: 5%;
        }
        .score { font-size: clamp(32px, 8vw, 64px); }
        .best-score { font-size: clamp(14px, 4vw, 24px); opacity: 0.8; }
        
        .bottom-ui-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
        }
        .message { 
            font-size: clamp(18px, 5vw, 32px);
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        #highscoreTable {
            font-size: clamp(12px, 3.5vw, 20px);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            display: none;
            border: 2px solid #fff;
            width: fit-content;
        }

        #soundToggle {
            position: absolute;
            top: 15px;
            right: 15px;
            width: clamp(40px, 10vw, 50px);
            height: clamp(40px, 10vw, 50px);
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #fff;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
        }
        #soundToggle svg {
            fill: white;
            width: 70%;
            height: 70%;
        }
    </style>
</head>
<body>
    <div id="game-wrapper">
        <div id="game-container">
            <div id="soundToggle" onclick="toggleSound()">
                <svg id="soundOnIcon" viewBox="0 0 24 24"><path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.02C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>
                <svg id="soundOffIcon" style="display:none" viewBox="0 0 24 24"><path d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18.01,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.48,12.43 16.5,12.22 16.5,12Z"/></svg>
            </div>
            <div id="ui">
                <div class="score-container">
                    <div id="scoreLabel" class="score">0</div>
                    <div id="bestLabel" class="best-score">BEST: 0</div>
                </div>
                <div class="bottom-ui-group">
                    <div id="messageLabel" class="message">LOADING...</div>
                    <div id="highscoreTable">
                        <div style="margin-bottom: 5px; font-weight: bold;">--- TOP 5 ---</div>
                        <div id="highscoreList"></div>
                    </div>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>

    <script>
        // Audio Logic
        let audioCtx;
        let isMuted = false;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function toggleSound() {
            isMuted = !isMuted;
            document.getElementById('soundOnIcon').style.display = isMuted ? 'none' : 'block';
            document.getElementById('soundOffIcon').style.display = isMuted ? 'block' : 'none';
        }

        function playSound(type) {
            if (!audioCtx || isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            let duration = 0.1;
            
            if (type === 'jump') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                duration = 0.1;
            } else if (type === 'score') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(987, now);
                osc.frequency.exponentialRampToValueAtTime(1318, now + 0.05);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                duration = 0.4;
            } else if (type === 'crash') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.5);
                duration = 0.5;
            }
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // Fix: Start the oscillator first, then schedule the stop
            osc.start(now);
            osc.stop(now + duration);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreLabel = document.getElementById('scoreLabel');
        const bestLabel = document.getElementById('bestLabel');
        const messageLabel = document.getElementById('messageLabel');
        const highscoreTable = document.getElementById('highscoreTable');
        const highscoreList = document.getElementById('highscoreList');

        const LOGIC_WIDTH = 800;
        const LOGIC_HEIGHT = 600;
        const GRAVITY = 1000;         
        const FLAP_SPEED = -350;     
        const PIPE_SPEED = 300;      
        const PIPE_SPAWN_INTERVAL = 1.4; 
        const PIPE_GAP = 190;        
        const BIRD_X = 150;

        let bird, pipes, clouds, score, gameState = 'LOADING';
        let highscores = JSON.parse(localStorage.getItem('flappyHighscores')) || [];
        let lastTime = 0;
        let spawnTimer = 0;

        function updateBestLabel() {
            const topScore = highscores.length > 0 ? highscores[0] : 0;
            bestLabel.innerText = `BEST: ${topScore}`;
        }

        function init() {
            canvas.width = LOGIC_WIDTH;
            canvas.height = LOGIC_HEIGHT;
            
            bird = {
                y: LOGIC_HEIGHT / 2,
                velocity: 0,
                width: 44,
                height: 32,
                rotation: 0
            };
            pipes = [];
            clouds = [
                { x: 100, y: 100, scale: 1.5 },
                { x: 400, y: 180, scale: 1.2 },
                { x: 700, y: 80, scale: 1.8 }
            ];
            score = 0;
            spawnTimer = 0;
            
            if (gameState !== 'LOADING') {
                gameState = 'START';
                messageLabel.innerText = 'PRESS SPACE OR TAP TO START';
                messageLabel.style.display = 'block';
            }
            scoreLabel.innerText = '0';
            updateBestLabel();
            highscoreTable.style.display = 'none';
        }

        function drawBird() {
            ctx.save();
            ctx.translate(BIRD_X + bird.width / 2, bird.y + bird.height / 2);
            ctx.rotate(bird.rotation);
            ctx.fillStyle = '#f8e71c';
            ctx.fillRect(-bird.width/2, -bird.height/2, bird.width, bird.height);
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeRect(-bird.width/2, -bird.height/2, bird.width, bird.height);
            ctx.fillStyle = '#fff';
            ctx.fillRect(10, -10, 12, 12);
            ctx.fillStyle = '#000';
            ctx.fillRect(18, -8, 4, 4);
            ctx.fillStyle = '#fff';
            ctx.fillRect(-16, 0, 18, 12);
            ctx.strokeRect(-16, 0, 18, 12);
            ctx.fillStyle = '#f5a623';
            ctx.fillRect(14, 6, 18, 12);
            ctx.strokeRect(14, 6, 18, 12);
            ctx.restore();
        }

        function drawPipe(p) {
            const pipeW = 80;
            ctx.fillStyle = '#2ecc71';
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 4;
            ctx.fillRect(p.x, 0, pipeW, p.top);
            ctx.strokeRect(p.x, 0, pipeW, p.top);
            ctx.fillRect(p.x - 10, p.top - 30, pipeW + 20, 30);
            ctx.strokeRect(p.x - 10, p.top - 30, pipeW + 20, 30);
            const bottomY = p.top + PIPE_GAP;
            ctx.fillRect(p.x, bottomY, pipeW, LOGIC_HEIGHT - bottomY);
            ctx.strokeRect(p.x, bottomY, pipeW, LOGIC_HEIGHT - bottomY);
            ctx.fillRect(p.x - 10, bottomY, pipeW + 20, 30);
            ctx.strokeRect(p.x - 10, bottomY, pipeW + 20, 30);
        }

        function update(dt) {
            if (gameState === 'PLAYING') {
                bird.velocity += GRAVITY * dt;
                bird.y += bird.velocity * dt;
                bird.rotation = Math.min(Math.PI / 2, Math.max(-Math.PI / 4, bird.velocity * 0.003));
                
                clouds.forEach(c => {
                    c.x -= 40 * dt; 
                    if (c.x < -200) c.x = LOGIC_WIDTH + 100;
                });

                spawnTimer += dt;
                if (spawnTimer >= PIPE_SPAWN_INTERVAL) {
                    const top = Math.random() * (LOGIC_HEIGHT - PIPE_GAP - 200) + 100;
                    pipes.push({ x: LOGIC_WIDTH, top: top, passed: false });
                    spawnTimer = 0;
                }

                pipes.forEach((p) => {
                    p.x -= PIPE_SPEED * dt;
                    if (BIRD_X + bird.width > p.x && BIRD_X < p.x + 80) {
                        if (bird.y < p.top || bird.y + bird.height > p.top + PIPE_GAP) gameOver();
                    }
                    if (!p.passed && p.x + 80 < BIRD_X) {
                        p.passed = true;
                        score++;
                        scoreLabel.innerText = score;
                        playSound('score');
                    }
                });
                if (pipes.length > 0 && pipes[0].x < -150) pipes.shift();
                if (bird.y + bird.height > LOGIC_HEIGHT - 25 || bird.y < 0) gameOver();
            }
        }

        function draw() {
            ctx.clearRect(0, 0, LOGIC_WIDTH, LOGIC_HEIGHT);
            clouds.forEach(c => {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                ctx.fillRect(c.x, c.y, 80 * c.scale, 40 * c.scale);
            });
            pipes.forEach(drawPipe);
            drawBird();
            ctx.fillStyle = '#ded895';
            ctx.fillRect(0, LOGIC_HEIGHT - 25, LOGIC_WIDTH, 25);
        }

        function flap() {
            if (gameState === 'LOADING') return;
            initAudio();
            if (gameState === 'START') {
                gameState = 'PLAYING';
                messageLabel.style.display = 'none';
            }
            if (gameState === 'PLAYING') {
                bird.velocity = FLAP_SPEED;
                playSound('jump');
            } else if (gameState === 'GAMEOVER') {
                init();
            }
        }

        function gameOver() {
            if (gameState === 'GAMEOVER') return;
            gameState = 'GAMEOVER';
            playSound('crash');
            highscores.push(score);
            highscores.sort((a, b) => b - a);
            highscores = highscores.slice(0, 5);
            localStorage.setItem('flappyHighscores', JSON.stringify(highscores));
            
            messageLabel.style.display = 'block';
            messageLabel.innerText = 'GAME OVER\nTAP TO RESTART';
            
            highscoreList.innerHTML = '';
            highscores.forEach((s, i) => {
                const div = document.createElement('div');
                div.innerText = `#${i+1} - SCORE: ${s}`;
                highscoreList.appendChild(div);
            });
            highscoreTable.style.display = 'block';
        }

        window.addEventListener('keydown', (e) => {
            if (['Space', 'KeyW', 'ArrowUp'].includes(e.code)) {
                flap();
                e.preventDefault();
            }
        });

        const handleInteraction = (e) => {
            if (e.target.closest('#soundToggle')) return;
            flap();
            if (e.type === 'touchstart') e.preventDefault();
        };

        window.addEventListener('mousedown', handleInteraction);
        window.addEventListener('touchstart', handleInteraction, { passive: false });

        function gameLoop(timestamp) {
            const dt = Math.min((timestamp - lastTime) / 1000, 0.032);
            lastTime = timestamp;
            update(dt);
            draw();
            requestAnimationFrame(gameLoop);
        }

        setTimeout(() => {
            gameState = 'START';
            messageLabel.innerText = 'PRESS SPACE OR TAP TO START';
            messageLabel.style.display = 'block';
        }, 1000);

        init();
        requestAnimationFrame((timestamp) => {
            lastTime = timestamp;
            gameLoop(timestamp);
        });
    </script>
</body>
</html>